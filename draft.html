<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Draft CMIM</title>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: url('cmim.png') center/cover no-repeat;
  opacity: 0.08;
  z-index: -1;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #fff;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

nav {
  background: #000;
  color: #fff;
  padding: 15px 20px;
  font-size: 18px;
  font-weight: bold;
}

main {
  flex: 1;
  padding: 20px;
  margin: 15px;
  background: rgba(255,255,255,.95);
  border-radius: 12px;
  text-align: center;
}

#status { font-size: 18px; margin-bottom: 10px; }
#timer { font-size: 26px; margin: 15px 0; color: #ff5722; font-weight: bold; }

#startBtn {
  padding: 10px 25px;
  background: linear-gradient(135deg,#4caf50,#2e7d32);
  border: none;
  color: #fff;
  font-size: 16px;
  border-radius: 10px;
  cursor: pointer;
}

.playerCard {
  width: 190px;
  padding: 12px;
  background: #f3f3f3;
  border-radius: 10px;
  border: 2px solid #4caf50;
  cursor: pointer;
  transition: .2s;
}

.playerCard.disabled {
  opacity: .4;
  cursor: not-allowed;
}

#playersPool {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 12px;
  margin-bottom: 30px;
}

#teams {
  display: flex;
  justify-content: center;
  gap: 40px;
}

.teamBox {
  width: 260px;
  padding: 15px;
  border-radius: 12px;
  border: 2px solid #4caf50;
  background: #fff;
}

.teamBox.active {
  box-shadow: 0 0 25px rgba(255,87,34,.8);
}

.teamPlayer {
  background: #e0e0e0;
  padding: 6px 10px;
  margin-bottom: 6px;
  border-radius: 6px;
  font-weight: bold;
}

.teamPlayer.capitao {
  background: #ffeb3b;
}
</style>
</head>

<body>

<nav>CMIM Draft</nav>

<main>
<h1>Draft</h1>
<p id="status">Aguardando confirmação dos capitães...</p>
<button id="startBtn">Confirmar Pronto</button>
<div id="timer"></div>

<h2>Jogadores Disponíveis</h2>
<div id="playersPool"></div>

<div id="teams">
  <div class="teamBox" id="teamBoxA">
    <h3>Time A</h3>
    <div id="teamA"></div>
  </div>
  <div class="teamBox" id="teamBoxB">
    <h3>Time B</h3>
    <div id="teamB"></div>
  </div>
</div>
</main>

<footer>CMIM © 2025</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDBBBrCIRHYE4G4KpTf-GDY4gwWJUMhltI",
  authDomain: "selecao-3d8f3.firebaseapp.com",
  projectId: "selecao-3d8f3"
});

const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const draftRef = doc(db, "drafts", params.get("draft"));
const myTeam = params.get("team");

const laneOrder = ["cap","top","jg","mid","adc","sup"];
let timerInterval;
let timeLeft = 30;
let lastPick = null;

/* TIMER */
function startTimer(team) {
  clearInterval(timerInterval);
  timeLeft = 30;

  timerInterval = setInterval(async () => {
    const snap = await getDoc(draftRef);
    const draft = snap.data();
    if (!draft.started || draft.currentPick !== team) return;

    document.getElementById("timer").textContent =
      `Tempo do Time ${team}: ${timeLeft}s`;

    timeLeft--;

    if (timeLeft < 0) {
      draft.currentPick = team === "A" ? "B" : "A";
      await updateDoc(draftRef, draft);
    }
  }, 1000);
}

function sortLane(arr) {
  return [...arr].sort(
    (a,b)=>laneOrder.indexOf(a.lane)-laneOrder.indexOf(b.lane)
  );
}

/* PICK COM LANE ESPELHADA */
async function pickPlayer(name) {
  const snap = await getDoc(draftRef);
  const draft = snap.data();
  if (!draft.started || draft.currentPick !== myTeam) return;

  // Player escolhido
  const picked = draft.players.find(p => p.name === name);
  if (!picked) return;

  const lane = picked.lane;
  const otherTeam = myTeam === "A" ? "B" : "A";

  // Outro player da mesma lane
  const mirrored = draft.players.find(
    p => p.lane === lane && p.name !== name
  );

  // Remove ambos do pool
  draft.players = draft.players.filter(
    p => p.name !== name && p.lane !== lane
  );

  // Adiciona aos times
  draft.teams[myTeam].push(picked);

  if (mirrored) {
    draft.teams[otherTeam].push(mirrored);
  }

  // Troca turno
  draft.currentPick = otherTeam;

  await updateDoc(draftRef, draft);
}

/* RENDER */
function renderDraft(draft) {

  /* GARANTE CAPITÃES FORA DO POOL */
  ["A","B"].forEach((t,i)=>{
    const capName = draft.captains[i];

    draft.players = draft.players.filter(p=>p.name !== capName);

    if (!draft.teams[t].some(p=>p.name === capName)) {
      draft.teams[t].unshift({
        name: capName,
        lane: "cap",
        tier: "CAP"
      });
    }
  });

  updateDoc(draftRef, draft);

  /* STATUS */
  if (!draft.started) {
    const ready = draft.playersStarted || [];
    document.getElementById("status").textContent =
      `Prontos: ${ready.join(" e ") || "nenhum"}`;
  } else {
    document.getElementById("status").textContent =
      `Vez do Time ${draft.currentPick}`;
  }

  /* POOL */
  const pool = document.getElementById("playersPool");
  pool.innerHTML = "";

  draft.players.forEach(p=>{
    const div = document.createElement("div");
    div.className = "playerCard";
    if (draft.currentPick !== myTeam)
      div.classList.add("disabled");

    div.innerHTML = `<strong>${p.name}</strong><br>${p.lane} | ${p.tier}`;
    div.onclick = ()=>pickPlayer(p.name);
    pool.appendChild(div);
  });

  /* TIMES */
  ["A","B"].forEach(t=>{
    const box = document.getElementById("team"+t);
    box.innerHTML = "";
    sortLane(draft.teams[t]).forEach(p=>{
      const d = document.createElement("div");
      d.className = "teamPlayer";
      if (draft.captains.includes(p.name)) d.classList.add("capitao");
      d.textContent = `${p.name} (${p.lane})`;
      box.appendChild(d);
    });
  });

  /* TIMER */
  if (draft.started && draft.currentPick !== lastPick) {
    lastPick = draft.currentPick;
    startTimer(draft.currentPick);
  }

  document.getElementById("teamBoxA").classList.toggle("active", draft.currentPick==="A");
  document.getElementById("teamBoxB").classList.toggle("active", draft.currentPick==="B");
}

/* START */
document.getElementById("startBtn").onclick = async () => {
  const snap = await getDoc(draftRef);
  const draft = snap.data();

  if (!draft.playersStarted) draft.playersStarted = [];
  if (!draft.playersStarted.includes(myTeam))
    draft.playersStarted.push(myTeam);

  if (draft.playersStarted.length === 2) {
    draft.started = true;
    draft.currentPick = "A";
    await updateDoc(draftRef, draft);
  } else {
    await updateDoc(draftRef, { playersStarted: arrayUnion(myTeam) });
  }
};

onSnapshot(draftRef, snap => renderDraft(snap.data()));
</script>

</body>
</html>
