<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Draft CMIM</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:
    radial-gradient(circle at top, rgba(255,200,0,.15), transparent 40%),
    url('cmim.png') center/cover no-repeat;
  opacity:.08;
  z-index:-1;
}
</style>
</head>

<body class="min-h-screen flex flex-col bg-gradient-to-br from-zinc-900 via-zinc-800 to-black text-zinc-100">

<nav class="px-6 py-4 flex justify-between items-center bg-black/70 backdrop-blur-xl border-b border-white/10">
  <span class="text-2xl font-extrabold tracking-wide">
    CMIM <span class="text-yellow-400">Draft</span>
  </span>
  <span class="text-sm text-zinc-400">Sistema Oficial</span>
</nav>

<main class="flex-1 p-6 max-w-7xl mx-auto w-full">

<div class="bg-white/10 backdrop-blur-2xl rounded-3xl shadow-2xl p-8 text-center border border-white/10">

<h1 class="text-4xl font-extrabold mb-3">Draft CMIM</h1>

<p id="status" class="text-lg mb-6 text-zinc-300">
Aguardando confirmação dos capitães...
</p>

<button id="startBtn"
class="px-8 py-3 rounded-2xl font-extrabold text-black
bg-gradient-to-r from-yellow-400 to-yellow-600
hover:scale-110 hover:shadow-[0_0_25px_rgba(250,204,21,.8)]
transition-all duration-300">
CONFIRMAR PRONTO
</button>

<div id="timer" class="text-3xl font-extrabold text-orange-400 my-6"></div>

<h2 class="text-2xl font-bold mt-10 mb-6">Jogadores Disponíveis</h2>
<div id="playersPool" class="flex flex-wrap justify-center gap-5 mb-10"></div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-10">

<!-- TIME A -->
<div id="teamBoxA" class="rounded-3xl p-5 bg-white/10 border border-white/10 transition-all duration-300">
  <h3 class="text-2xl font-extrabold mb-4 text-green-400">Time A</h3>
  <div id="teamA" class="space-y-3"></div>
  <div id="overallA" class="mt-4 text-lg font-extrabold text-yellow-400">
    Overall: 0
  </div>
</div>

<!-- TIME B -->
<div id="teamBoxB" class="rounded-3xl p-5 bg-white/10 border border-white/10 transition-all duration-300">
  <h3 class="text-2xl font-extrabold mb-4 text-green-400">Time B</h3>
  <div id="teamB" class="space-y-3"></div>
  <div id="overallB" class="mt-4 text-lg font-extrabold text-yellow-400">
    Overall: 0
  </div>
</div>

</div>
</div>
</main>

<footer class="bg-black/70 backdrop-blur-xl border-t border-white/10 text-center py-4 text-sm text-zinc-400">
CMIM © 2025 • Insalubramente competitivo
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDBBBrCIRHYE4G4pTf-GDY4gwWJUMhltI",
  authDomain: "selecao-3d8f3.firebaseapp.com",
  projectId: "selecao-3d8f3"
});

const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const draftRef = doc(db,"drafts",params.get("draft"));
const myTeam = params.get("team");

const laneOrder = ["top","jg","mid","adc","sup"];
let timerInterval;
let timeLeft = 30;
let lastPick = null;

/* TIERS */
const tierValues = {
  S: 20,
  "A+": 18,
  A: 17,
  "A-": 15,
  B: 10,
  C: 7,
  D: 4,
  E: 2,
  F: 1
};

const tierColors = {
  S:"text-red-400",
  "A+":"text-emerald-300",
  A:"text-emerald-400",
  "A-":"text-emerald-600",
  B:"text-yellow-400",
  C:"text-blue-400",
  D:"text-orange-400",
  E:"text-gray-400",
  F:"text-white"
};

const laneColors = {
  top:"border-blue-400 bg-blue-400/10",
  jg:"border-blue-400 bg-blue-400/10",
  mid:"border-blue-400 bg-blue-400/10",
  adc:"border-blue-400 bg-blue-400/10",
  sup:"border-blue-400 bg-blue-400/10"
};

function calculateOverall(team){
  return team.reduce((sum,p)=>sum+(tierValues[p.tier]||0),0);
}

function stopTimer(){
  clearInterval(timerInterval);
  document.getElementById("timer").textContent="";
}

function startTimer(team){
  clearInterval(timerInterval);
  timeLeft=30;
  timerInterval=setInterval(async()=>{
    const snap=await getDoc(draftRef);
    const draft=snap.data();
    if(!draft.started||draft.finished||draft.currentPick!==team)return;
    document.getElementById("timer").textContent=`Tempo do Time ${team}: ${timeLeft}s`;
    timeLeft--;
    if(timeLeft<0){
      draft.currentPick=team==="A"?"B":"A";
      await updateDoc(draftRef,draft);
    }
  },1000);
}

function sortLane(arr){
  return [...arr].sort((a,b)=>laneOrder.indexOf(a.lane)-laneOrder.indexOf(b.lane));
}

async function pickPlayer(name){
  const snap=await getDoc(draftRef);
  const draft=snap.data();
  if(!draft.started||draft.finished||draft.currentPick!==myTeam)return;

  const picked=draft.players.find(p=>p.name===name);
  if(!picked)return;

  const other=myTeam==="A"?"B":"A";
  const mirrored=draft.players.find(p=>p.lane===picked.lane&&p.name!==name);

  draft.players=draft.players.filter(p=>p.name!==name&&p.lane!==picked.lane);
  draft.teams[myTeam].push(picked);
  if(mirrored) draft.teams[other].push(mirrored);

  if(draft.players.length===0){
    draft.finished=true;
    stopTimer();
  }else{
    draft.currentPick=other;
  }

  await updateDoc(draftRef,draft);
}

function renderDraft(draft){
  document.getElementById("playersPool").innerHTML="";

  draft.players.forEach(p=>{
    const d=document.createElement("div");
    d.className=`w-44 p-4 rounded-2xl border-2 ${laneColors[p.lane]} cursor-pointer hover:scale-110 transition`;
    d.innerHTML=`
      <div class="font-bold">${p.name}</div>
      <div class="text-xs">${p.lane}</div>
      <div class="text-xs ${tierColors[p.tier]}">Tier ${p.tier}</div>
    `;
    d.onclick=()=>pickPlayer(p.name);
    document.getElementById("playersPool").appendChild(d);
  });

  ["A","B"].forEach(t=>{
    const box=document.getElementById("team"+t);
    box.innerHTML="";
    sortLane(draft.teams[t]).forEach(p=>{
      const d=document.createElement("div");
      d.className=`px-3 py-2 rounded-xl border ${laneColors[p.lane]} font-bold text-sm`;
      d.innerHTML=`${p.name} <span class="${tierColors[p.tier]}">(${p.tier})</span>`;
      box.appendChild(d);
    });
  });

  document.getElementById("overallA").textContent=`Overall: ${calculateOverall(draft.teams.A)}`;
  document.getElementById("overallB").textContent=`Overall: ${calculateOverall(draft.teams.B)}`;
}

document.getElementById("startBtn").onclick=async()=>{
  const snap=await getDoc(draftRef);
  const draft=snap.data();

  if(!draft.playersStarted) draft.playersStarted=[];
  if(!draft.playersStarted.includes(myTeam))
    draft.playersStarted.push(myTeam);

  if(draft.playersStarted.length===2){
    draft.captains.forEach((cap,i)=>{
      const team=i===0?"A":"B";
      const p=draft.players.find(pl=>pl.name===cap);
      if(!p)return;
      draft.teams[team].push(p);
      draft.players=draft.players.filter(pl=>pl.name!==cap);
    });
    draft.started=true;
    draft.currentPick="A";
    await updateDoc(draftRef,draft);
  }else{
    await updateDoc(draftRef,{playersStarted:arrayUnion(myTeam)});
  }
};

onSnapshot(draftRef,snap=>renderDraft(snap.data()));
</script>

</body>
</html>
