<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Draft CMIM</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
  body::before {
    content: "";
    position: fixed;
    inset: 0;
    background: url('cmim.png') center/cover no-repeat;
    opacity: 0.06;
    z-index: -1;
  }
</style>
</head>

<body class="min-h-screen flex flex-col bg-gray-100 text-gray-800">

<!-- NAV -->
<nav class="bg-black text-white px-6 py-4 text-xl font-bold">
  CMIM Draft
</nav>

<!-- MAIN -->
<main class="flex-1 p-6 max-w-7xl mx-auto w-full">

  <div class="bg-white/95 rounded-2xl shadow-xl p-6 text-center">

    <h1 class="text-3xl font-extrabold mb-2">Draft</h1>

    <p id="status" class="text-lg mb-4">
      Aguardando confirmação dos capitães...
    </p>

    <button id="startBtn"
      class="px-6 py-3 rounded-xl font-bold text-white
      bg-gradient-to-r from-green-500 to-green-700
      hover:scale-105 transition">
      Confirmar Pronto
    </button>

    <div id="timer" class="text-2xl font-bold text-orange-500 my-4"></div>

    <!-- PLAYERS -->
    <h2 class="text-2xl font-bold mt-6 mb-4">Jogadores Disponíveis</h2>

    <div id="playersPool"
      class="flex flex-wrap justify-center gap-4 mb-8">
    </div>

    <!-- TEAMS -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 justify-center">

      <div id="teamBoxA"
        class="border-2 border-green-500 rounded-2xl p-4 bg-white transition">
        <h3 class="text-xl font-bold mb-3">Time A</h3>
        <div id="teamA" class="space-y-2"></div>
      </div>

      <div id="teamBoxB"
        class="border-2 border-green-500 rounded-2xl p-4 bg-white transition">
        <h3 class="text-xl font-bold mb-3">Time B</h3>
        <div id="teamB" class="space-y-2"></div>
      </div>

    </div>

  </div>
</main>

<!-- FOOTER -->
<footer class="bg-black text-white text-center py-3">
  CMIM © 2025
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDBBBrCIRHYE4G4KpTf-GDY4gwWJUMhltI",
  authDomain: "selecao-3d8f3.firebaseapp.com",
  projectId: "selecao-3d8f3"
});

const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const draftRef = doc(db, "drafts", params.get("draft"));
const myTeam = params.get("team");

const laneOrder = ["cap","top","jg","mid","adc","sup"];
let timerInterval;
let timeLeft = 30;
let lastPick = null;

/* SONS */
const clickSound = new Audio("click.mp3");
const pickSound = new Audio("pick.mp3");
const finishSound = new Audio("finish.mp3");

function stopTimer() {
  clearInterval(timerInterval);
  document.getElementById("timer").textContent = "";
}

function startTimer(team) {
  clearInterval(timerInterval);
  timeLeft = 30;

  timerInterval = setInterval(async () => {
    const snap = await getDoc(draftRef);
    const draft = snap.data();
    if (!draft.started || draft.finished || draft.currentPick !== team) return;

    document.getElementById("timer").textContent =
      `Tempo do Time ${team}: ${timeLeft}s`;

    timeLeft--;

    if (timeLeft < 0) {
      draft.currentPick = team === "A" ? "B" : "A";
      await updateDoc(draftRef, draft);
    }
  }, 1000);
}

function sortLane(arr) {
  return [...arr].sort(
    (a,b)=>laneOrder.indexOf(a.lane)-laneOrder.indexOf(b.lane)
  );
}

async function pickPlayer(name) {
  const snap = await getDoc(draftRef);
  const draft = snap.data();
  if (!draft.started || draft.finished || draft.currentPick !== myTeam) return;

  pickSound.play();

  const picked = draft.players.find(p => p.name === name);
  if (!picked) return;

  const lane = picked.lane;
  const otherTeam = myTeam === "A" ? "B" : "A";

  const mirrored = draft.players.find(
    p => p.lane === lane && p.name !== name
  );

  draft.players = draft.players.filter(
    p => p.name !== name && p.lane !== lane
  );

  draft.teams[myTeam].push(picked);
  if (mirrored) draft.teams[otherTeam].push(mirrored);

  if (draft.players.length === 0) {
    draft.finished = true;
    stopTimer();
    finishSound.play();
  } else {
    draft.currentPick = otherTeam;
  }

  await updateDoc(draftRef, draft);
}

function renderDraft(draft) {

  ["A","B"].forEach((t,i)=>{
    const cap = draft.captains[i];
    draft.players = draft.players.filter(p=>p.name!==cap);
    if (!draft.teams[t].some(p=>p.name===cap)) {
      draft.teams[t].unshift({ name: cap, lane:"cap", tier:"CAP" });
    }
  });
  updateDoc(draftRef, draft);

  const status = document.getElementById("status");
  status.className = "text-lg mb-4";

  if (draft.finished) {
    status.textContent = "TIMES DEFINIDOS";
    status.classList.add("text-3xl","font-extrabold","text-green-600");
  } else if (!draft.started) {
    const ready = draft.playersStarted || [];
    status.textContent = `Prontos: ${ready.join(" e ") || "nenhum"}`;
  } else {
    status.textContent = `Vez do Time ${draft.currentPick}`;
  }

  const pool = document.getElementById("playersPool");
  pool.innerHTML = "";

  draft.players.forEach(p=>{
    const div = document.createElement("div");
    div.className = `
      w-44 p-3 rounded-xl border-2 border-green-500 bg-gray-100
      cursor-pointer transition hover:scale-105 text-sm font-semibold
    `;

    if (draft.currentPick !== myTeam || draft.finished) {
      div.classList.add("opacity-40","cursor-not-allowed");
    }

    div.innerHTML = `<strong>${p.name}</strong><br>${p.lane} | ${p.tier}`;
    div.onclick = ()=>pickPlayer(p.name);
    pool.appendChild(div);
  });

  ["A","B"].forEach(t=>{
    const box = document.getElementById("team"+t);
    const teamBox = document.getElementById("teamBox"+t);
    box.innerHTML = "";

    if (draft.finished) {
      teamBox.classList.add("shadow-[0_0_30px_rgba(34,197,94,0.9)]","scale-105");
    }

    sortLane(draft.teams[t]).forEach(p=>{
      const d = document.createElement("div");
      d.className = "bg-gray-200 rounded-lg px-3 py-1 font-bold";

      if (draft.captains.includes(p.name)) {
        d.classList.add("bg-yellow-300");
      }

      d.textContent = `${p.name} (${p.lane})`;
      box.appendChild(d);
    });
  });

  if (draft.started && !draft.finished && draft.currentPick !== lastPick) {
    lastPick = draft.currentPick;
    startTimer(draft.currentPick);
  }

  document.getElementById("teamBoxA")
    .classList.toggle("shadow-[0_0_25px_rgba(255,87,34,.8)]", draft.currentPick==="A");
  document.getElementById("teamBoxB")
    .classList.toggle("shadow-[0_0_25px_rgba(255,87,34,.8)]", draft.currentPick==="B");
}

document.getElementById("startBtn").onclick = async () => {
  clickSound.play();
  const snap = await getDoc(draftRef);
  const draft = snap.data();

  if (!draft.playersStarted) draft.playersStarted = [];
  if (!draft.playersStarted.includes(myTeam))
    draft.playersStarted.push(myTeam);

  if (draft.playersStarted.length === 2) {
    draft.started = true;
    draft.currentPick = "A";
    await updateDoc(draftRef, draft);
  } else {
    await updateDoc(draftRef, { playersStarted: arrayUnion(myTeam) });
  }
};

onSnapshot(draftRef, snap => renderDraft(snap.data()));
</script>

</body>
</html>
